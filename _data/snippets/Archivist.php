id: 15
name: Archivist
category: Archivist
properties: 'a:26:{s:3:"tpl";a:7:{s:4:"name";s:3:"tpl";s:4:"desc";s:23:"prop_archivist.tpl_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:3:"row";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:6:"target";a:7:{s:4:"name";s:6:"target";s:4:"desc";s:26:"prop_archivist.target_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:7:"parents";a:7:{s:4:"name";s:7:"parents";s:4:"desc";s:27:"prop_archivist.parents_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:5:"depth";a:7:{s:4:"name";s:5:"depth";s:4:"desc";s:25:"prop_archivist.depth_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:2:"10";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:7:"exclude";a:7:{s:4:"name";s:7:"exclude";s:4:"desc";s:27:"prop_archivist.exclude_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:6:"sortBy";a:7:{s:4:"name";s:6:"sortBy";s:4:"desc";s:26:"prop_archivist.sortby_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:11:"publishedon";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:7:"sortDir";a:7:{s:4:"name";s:7:"sortDir";s:4:"desc";s:27:"prop_archivist.sortdir_desc";s:4:"type";s:4:"list";s:7:"options";a:2:{i:0;a:2:{s:4:"text";s:18:"prop_arc.ascending";s:5:"value";s:3:"ASC";}i:1;a:2:{s:4:"text";s:19:"prop_arc.descending";s:5:"value";s:4:"DESC";}}s:5:"value";s:4:"DESC";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:5:"limit";a:7:{s:4:"name";s:5:"limit";s:4:"desc";s:25:"prop_archivist.limit_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:2:"12";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:5:"start";a:7:{s:4:"name";s:5:"start";s:4:"desc";s:25:"prop_archivist.start_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:1:"0";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:8:"useMonth";a:7:{s:4:"name";s:8:"useMonth";s:4:"desc";s:28:"prop_archivist.usemonth_desc";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:1;s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:6:"useDay";a:7:{s:4:"name";s:6:"useDay";s:4:"desc";s:26:"prop_archivist.useday_desc";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:0;s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:11:"groupByYear";a:7:{s:4:"name";s:11:"groupByYear";s:4:"desc";s:31:"prop_archivist.groupbyyear_desc";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:0;s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:14:"groupByYearTpl";a:7:{s:4:"name";s:14:"groupByYearTpl";s:4:"desc";s:34:"prop_archivist.groupbyyeartpl_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:9:"yeargroup";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:10:"dateFormat";a:7:{s:4:"name";s:10:"dateFormat";s:4:"desc";s:30:"prop_archivist.dateformat_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:8:"useFurls";a:7:{s:4:"name";s:8:"useFurls";s:4:"desc";s:23:"prop_archivist.usefurls";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:1;s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:16:"persistGetParams";a:7:{s:4:"name";s:16:"persistGetParams";s:4:"desc";s:36:"prop_archivist.persistgetparams_desc";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:0;s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:11:"extraParams";a:7:{s:4:"name";s:11:"extraParams";s:4:"desc";s:31:"prop_archivist.extraparams_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:3:"cls";a:7:{s:4:"name";s:3:"cls";s:4:"desc";s:23:"prop_archivist.cls_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:7:"arc-row";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:6:"altCls";a:7:{s:4:"name";s:6:"altCls";s:4:"desc";s:26:"prop_archivist.altcls_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:11:"arc-row-alt";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:8:"firstCls";a:7:{s:4:"name";s:8:"firstCls";s:4:"desc";s:28:"prop_archivist.firstcls_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:7:"lastCls";a:7:{s:4:"name";s:7:"lastCls";s:4:"desc";s:27:"prop_archivist.lastcls_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:12:"filterPrefix";a:7:{s:4:"name";s:12:"filterPrefix";s:4:"desc";s:32:"prop_archivist.filterprefix_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:4:"arc_";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:13:"toPlaceholder";a:7:{s:4:"name";s:13:"toPlaceholder";s:4:"desc";s:33:"prop_archivist.toplaceholder_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";s:0:"";s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:9:"setLocale";a:7:{s:4:"name";s:9:"setLocale";s:4:"desc";s:29:"prop_archivist.setlocale_desc";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:1;s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:6:"locale";a:7:{s:4:"name";s:6:"locale";s:4:"desc";s:26:"prop_archivist.locale_desc";s:4:"type";s:9:"textfield";s:7:"options";s:0:"";s:5:"value";b:1;s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}s:14:"hideContainers";a:7:{s:4:"name";s:14:"hideContainers";s:4:"desc";s:41:"prop_archivistbymonth.hidecontainers_desc";s:4:"type";s:13:"combo-boolean";s:7:"options";s:0:"";s:5:"value";b:1;s:7:"lexicon";s:20:"archivist:properties";s:4:"area";s:0:"";}}'

-----

/**
 * Archivist
 *
 * Copyright 2010-2011 by Shaun McCormick <shaun@modx.com>
 *
 * This file is part of Archivist, a simple archive navigation system for MODx
 * Revolution.
 *
 * Archivist is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation; either version 2 of the License, or (at your option) any later
 * version.
 *
 * Archivist is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 *
 * You should have received a copy of the GNU General Public License along with
 * Archivist; if not, write to the Free Software Foundation, Inc., 59 Temple
 * Place, Suite 330, Boston, MA 02111-1307 USA
 *
 * @package archivist
 */
/**
 * Display an archived result filter list
 *
 * @var modX $modx
 * @var array $scriptProperties
 * @var Archivist $archivist
 *
 * @package archivist
 */
$archivist = $modx->getService('archivist','Archivist',$modx->getOption('archivist.core_path',null,$modx->getOption('core_path').'components/archivist/').'model/archivist/',$scriptProperties);
if (!($archivist instanceof Archivist)) return '';

/* setup default properties */
$tpl = $modx->getOption('tpl',$scriptProperties,'row');
$parents = !empty($scriptProperties['parents']) ? $scriptProperties['parents'] : $modx->resource->get('id');
$parents = explode(',',$parents);
$target = !empty($scriptProperties['target']) ? $scriptProperties['target'] : $modx->resource->get('id');
$sortBy = $modx->getOption('sortBy',$scriptProperties,'publishedon');
$sortDir = $modx->getOption('sortDir',$scriptProperties,'DESC');
$groupByYear = $modx->getOption('groupByYear',$scriptProperties,false);
$sortYear = $modx->getOption('sortYear',$scriptProperties,'DESC');
$depth = $modx->getOption('depth',$scriptProperties,10);
$where = $modx->getOption('where',$scriptProperties,'');

$cls = $modx->getOption('cls',$scriptProperties,'arc-row');
$altCls = $modx->getOption('altCls',$scriptProperties,'arc-row-alt');
$lastCls = $modx->getOption('lastCls',$scriptProperties,'');
$firstCls = $modx->getOption('firstCls',$scriptProperties,'');

$filterPrefix = $modx->getOption('filterPrefix',$scriptProperties,'arc_');
$useMonth = $modx->getOption('useMonth',$scriptProperties,true);
$useDay = $modx->getOption('useDay',$scriptProperties,false);
$dateFormat = !empty($scriptProperties['dateFormat']) ? $scriptProperties['dateFormat'] : '';
$limit = $modx->getOption('limit',$scriptProperties,12);
$start = $modx->getOption('start',$scriptProperties,0);
$hideContainers = $modx->getOption('hideContainers',$scriptProperties,true);
$useFurls = $modx->getOption('useFurls',$scriptProperties,true);
$persistGetParams = $modx->getOption('persistGetParams',$scriptProperties,false);

/* handle existing GET params */
$extraParams = $modx->getOption('extraParams',$scriptProperties,array());
$extraParams = $archivist->mergeGetParams($extraParams,$persistGetParams,$filterPrefix);

/* set locale for date processing */
if ($modx->getOption('setLocale',$scriptProperties,true)) {
    $cultureKey = $modx->getOption('cultureKey',null,'en');
    $locale = !empty($scriptProperties['locale']) ? $scriptProperties['locale'] : $cultureKey;
    if (!empty($locale)) {
        setlocale(LC_ALL,$locale);
    }
}

/* find children of parents */
$children = array();
foreach ($parents as $parent) {
    $pchildren = $modx->getChildIds($parent, $depth);
    if (!empty($pchildren)) $children = array_merge($children, $pchildren);
}
if (!empty($children)) $parents = array_merge($parents, $children);

/* get filter format */
$dateEmpty = empty($dateFormat);
$sqlDateFormat = '%Y';
if ($dateEmpty) $dateFormat = '%Y';
if ($useMonth) {
    if ($dateEmpty) $dateFormat = '%B '.$dateFormat;
    $sqlDateFormat = '%b '.$sqlDateFormat;
}
if ($useDay) {
    if ($dateEmpty) $dateFormat = '%d '.$dateFormat;
    $sqlDateFormat = '%d '.$sqlDateFormat;
}
/* build query */
$c = $modx->newQuery('modResource');
$fields = $modx->getSelectColumns('modResource','','',array('id',$sortBy));
$c->select($fields);
$c->select(array(
    'FROM_UNIXTIME('.$sortBy.',"'.$sqlDateFormat.'") AS '.$modx->escape('date'),
    'FROM_UNIXTIME('.$sortBy.',"'.$sqlDateFormat.'") AS '.$modx->escape('date'),
    'FROM_UNIXTIME('.$sortBy.',"%D") AS '.$modx->escape('day_formatted'),
    'COUNT('.$modx->escape('id').') AS '.$modx->escape('count'),
));
$c->where(array(
    'parent:IN' => $parents,
    'published' => true,
    'deleted' => false,
));
/* don't grab unpublished resources */
$c->where(array(
    'published' => true,
));
if ($hideContainers) {
    $c->where(array(
        'isfolder' => false,
    ));
}
if (!empty($where)) {
    $where = $modx->fromJSON($where);
    $c->where($where);
}
$exclude = $modx->getOption('exclude',$scriptProperties,'');
if (!empty($exclude)) {
    $c->where(array(
        'id:NOT IN' => is_array($exclude) ? $exclude : explode(',',$exclude),
    ));
}
$c->sortby('FROM_UNIXTIME(`'.$sortBy.'`,"%Y") '.$sortDir.', FROM_UNIXTIME(`'.$sortBy.'`,"%m") '.$sortDir.', FROM_UNIXTIME(`'.$sortBy.'`,"%d") '.$sortDir,'');
$c->groupby('FROM_UNIXTIME(`'.$sortBy.'`,"'.$sqlDateFormat.'")');
/* if limiting to X records */
if (!empty($limit)) { $c->limit($limit,$start); }
$resources = $modx->getCollection('modResource',$c);

/* iterate over resources */
$output = array();
$groupByYearOutput = array();
$idx = 0;
$count = $modx->getCount('modResource',$c);
/** @var modResource $resource */
foreach ($resources as $resource) {
    $resourceArray = $resource->toArray();

    $date = $resource->get($sortBy);
    $dateObj = strtotime($date);

    $resourceArray['date'] = strftime($dateFormat,$dateObj);
    $resourceArray['month_name_abbr'] = strftime('%b',$dateObj);
    $resourceArray['month_name'] = strftime('%B',$dateObj);
    $resourceArray['month'] = strftime('%m',$dateObj);
    $resourceArray['year'] = strftime('%Y',$dateObj);
    $resourceArray['year_two_digit'] = strftime('%y',$dateObj);
    $resourceArray['day'] = strftime('%d',$dateObj);
    $resourceArray['weekday'] = strftime('%A',$dateObj);
    $resourceArray['weekday_abbr'] = strftime('%a',$dateObj);
    $resourceArray['weekday_idx'] = strftime('%w',$dateObj);

    /* css classes */
    $resourceArray['cls'] = $cls;
    if ($idx % 2) { $resourceArray['cls'] .= ' '.$altCls; }
    if ($idx == 0 && !empty($firstCls)) { $resourceArray['cls'] .= ' '.$firstCls; }
    if ($idx+1 == $count && !empty($lastCls)) { $resourceArray['cls'] .= ' '.$lastCls; }

    /* setup GET params */
    $params = array();
    $params[$filterPrefix.'year'] = $resourceArray['year'];

    /* if using month filter */
    if ($useMonth) {
        $params[$filterPrefix.'month'] = $resourceArray['month'];
    }
    /* if using day filter (why you would ever is beyond me...) */
    if ($useDay) {
        $params[$filterPrefix.'day'] = $resourceArray['day'];
        if (empty($scriptProperties['dateFormat'])) {
            $resourceArray['date'] = $resourceArray['month_name'].' '.$resourceArray['day'].', '.$resourceArray['year'];
        }
    }

    if ($useFurls) {
        $params = implode('/',$params);
        if (!empty($extraParams)) $params .= '?'.$extraParams;
        $resourceArray['url'] = $modx->makeUrl($target).$params;
    } else {
        $params = http_build_query($params);
        if (!empty($extraParams)) $params .= '&'.$extraParams;
        $resourceArray['url'] = $modx->makeUrl($target,'',$params);
    }

    if ($groupByYear) {
        $groupByYearOutput[$resourceArray['year']][] = $resourceArray;
    } else {
        $output[] = $archivist->getChunk($tpl,$resourceArray);
    }

    $idx++;
}

if ($groupByYear) {
    $wrapperTpl = $modx->getOption('yearGroupTpl',$scriptProperties,'yeargroup');
    $wrapperRowSeparator = $modx->getOption('yearGroupRowSeparator',$scriptProperties,"\n");
    if (strtolower($sortYear) === 'asc') {
        ksort($groupByYearOutput);
    } else {
        krsort($groupByYearOutput);
    }
    foreach ($groupByYearOutput as $year => $row) {
        $wrapper['year'] = $year;

        $params = array();
        $params[$filterPrefix.'year'] = $year;

        if ($useFurls) {
            $params = implode('/',$params);
            if (!empty($extraParams)) $params .= '?'.$extraParams;
            $wrapper['url'] = $modx->makeUrl($target).$params;
        } else {
            $params = http_build_query($params);
            if (!empty($extraParams)) $params .= '&'.$extraParams;
            $wrapper['url'] = $modx->makeUrl($target,'',$params);
        }

        $wrapper['row'] = array();
        foreach ($row as $month) {
            $wrapper['row'][] = $archivist->getChunk($tpl,$month);
        }
        $wrapper['row'] = implode($wrapperRowSeparator,$wrapper['row']);
        $output[] = $archivist->getChunk($wrapperTpl,$wrapper);
    }
}

/* output or set to placeholder */
$outputSeparator = $modx->getOption('outputSeparator',$scriptProperties,"\n");
$output = implode($outputSeparator,$output);
$toPlaceholder = $modx->getOption('toPlaceholder',$scriptProperties,false);
if (!empty($toPlaceholder)) {
    $modx->setPlaceholder($toPlaceholder,$output);
    return '';
}
return $output;